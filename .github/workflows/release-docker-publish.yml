name: Build, Push, and Export Deployment YAML

on:
  push:
    branches:
      - release

permissions:
  contents: read

env:
  BACKEND_IMAGE: shubham16negi/cloud-agentic-skill-backend
  DASHBOARD_IMAGE: shubham16negi/cloud-agentic-skill-dashboard

jobs:
  build-push-and-export:
    if: github.ref == 'refs/heads/release'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.backend
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:latest
            ${{ env.BACKEND_IMAGE }}:${{ github.sha }}

      - name: Build and push dashboard image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.dashboard
          push: true
          tags: |
            ${{ env.DASHBOARD_IMAGE }}:latest
            ${{ env.DASHBOARD_IMAGE }}:${{ github.sha }}

      - name: Generate deployment YAML
        run: |
          cat > deployment.yaml <<'EOF'
          apiVersion: v1
          kind: List
          items:
            - apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: cloud-agentic-skill-backend
                labels:
                  app: cloud-agentic-skill-backend
              spec:
                replicas: 1
                selector:
                  matchLabels:
                    app: cloud-agentic-skill-backend
                template:
                  metadata:
                    labels:
                      app: cloud-agentic-skill-backend
                  spec:
                    containers:
                      - name: backend
                        image: ${{ env.BACKEND_IMAGE }}:latest
                        imagePullPolicy: Always
                        env:
                          - name: APP_NAME
                            value: "Cloud Agentic Skill Manager"
                          - name: DEBUG
                            value: "false"
                          - name: ELASTICSEARCH_URL
                            value: "http://localhost:9200"
                          - name: ELASTICSEARCH_USERNAME
                            value: ""
                          - name: ELASTICSEARCH_PASSWORD
                            value: ""
                          - name: ELASTICSEARCH_VERIFY_CERTS
                            value: "true"
                          - name: ELASTICSEARCH_INDEX
                            value: "agent_skills"
                          - name: ELASTICSEARCH_USER_INDEX
                            value: "skill_users"
                          - name: ELASTICSEARCH_API_KEY_INDEX
                            value: "skill_api_keys"
                          - name: EMBEDDING_MODEL
                            value: "all-MiniLM-L6-v2"
                          - name: EMBEDDING_DIMS
                            value: "384"
                          - name: MODEL_CACHE_DIR
                            value: "./models"
                          - name: SECRET_KEY
                            value: "change-me-in-production"
                          - name: ACCESS_TOKEN_EXPIRE_MINUTES
                            value: "60"
                          - name: DEFAULT_ADMIN_USERNAME
                            value: "admin"
                          - name: DEFAULT_ADMIN_PASSWORD
                            value: "admin"
                          - name: BACKEND_HOST
                            value: "0.0.0.0"
                          - name: BACKEND_PORT
                            value: "8000"
                          - name: BACKEND_URL
                            value: "http://localhost:8000"
                        ports:
                          - containerPort: 8000
            - apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: cloud-agentic-skill-dashboard
                labels:
                  app: cloud-agentic-skill-dashboard
              spec:
                replicas: 1
                selector:
                  matchLabels:
                    app: cloud-agentic-skill-dashboard
                template:
                  metadata:
                    labels:
                      app: cloud-agentic-skill-dashboard
                  spec:
                    containers:
                      - name: dashboard
                        image: ${{ env.DASHBOARD_IMAGE }}:latest
                        imagePullPolicy: Always
                        env:
                          - name: BACKEND_URL
                            value: "http://localhost:8000"
                        ports:
                          - containerPort: 8501
          EOF

      - name: Upload deployment YAML artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-yaml
          path: deployment.yaml